<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IoT Light Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        .chart-container { position: relative; height: 400px; width: 100%; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #007bff; color: white; }
        tr:hover { background-color: #f1f1f1; }
        .status { text-align: center; margin-bottom: 10px; color: #666; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    <h1>üí° Gi√°m S√°t √Ånh S√°ng Th·ªùi Gian Th·ª±c</h1>
    <div class="status">D·ªØ li·ªáu t·ª± c·∫≠p nh·∫≠t m·ªói 5 gi√¢y</div>

    <div class="chart-container">
        <canvas id="luxChart"></canvas>
    </div>

    <h3>L·ªãch s·ª≠ ƒëo g·∫ßn nh·∫•t</h3>
    <table id="dataTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Device</th>
                <th>Lux (C∆∞·ªùng ƒë·ªô)</th>
                <th>Th·ªùi gian</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
</div>

<script>
    let myChart = null;

    // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì r·ªóng
    function initChart() {
        const ctx = document.getElementById('luxChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Th·ªùi gian
                datasets: [{
                    label: 'C∆∞·ªùng ƒë·ªô s√°ng (Lux)',
                    data: [],
                    borderColor: '#FF9800',
                    backgroundColor: 'rgba(255, 152, 0, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4 // L√†m m∆∞·ª£t ƒë∆∞·ªùng cong
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                animation: false // T·∫Øt hi·ªáu ·ª©ng load l·∫°i ƒë·ªÉ ƒë·ª° gi·∫≠t
            }
        });
    }

    // H√†m format ng√†y th√°ng cho ƒë·∫πp
    function formatDate(isoString) {
        const d = new Date(isoString);
        return d.toLocaleString('vi-VN');
    }

    // H√†m l·∫•y d·ªØ li·ªáu v√† update giao di·ªán
    async function reloadData() {
        try {
            // G·ªçi API l·∫•y 50 ƒëi·ªÉm d·ªØ li·ªáu m·ªõi nh·∫•t
            const response = await fetch('/api/readings?limit=20'); // L·∫•y 20 ƒëi·ªÉm v·∫Ω cho ƒë·∫πp
            const data = await response.json(); 
            // Data tr·∫£ v·ªÅ ƒë√£ ƒë∆∞·ª£c sort C≈© -> M·ªõi t·ª´ API

            // 1. Update Bi·ªÉu ƒê·ªì
            const labels = data.map(item => {
                const d = new Date(item.timestamp);
                return d.toLocaleTimeString('vi-VN'); // Ch·ªâ l·∫•y gi·ªù ph√∫t gi√¢y
            });
            const values = data.map(item => item.lux);

            myChart.data.labels = labels;
            myChart.data.datasets[0].data = values;
            myChart.update();

            // 2. Update B·∫£ng (ƒê·∫£o ng∆∞·ª£c l·∫°i ƒë·ªÉ M·ªõi nh·∫•t l√™n ƒë·∫ßu)
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = ''; // X√≥a c≈©
            
            // Clone m·∫£ng data r·ªìi ƒë·∫£o ng∆∞·ª£c ƒë·ªÉ hi·ªÉn th·ªã b·∫£ng
            [...data].reverse().forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.id}</td>
                    <td>${row.device_id}</td>
                    <td style="font-weight:bold; color:#FF5722">${row.lux.toFixed(2)}</td>
                    <td>${formatDate(row.timestamp)}</td>
                `;
                tbody.appendChild(tr);
            });

        } catch (error) {
            console.error("L·ªói t·∫£i d·ªØ li·ªáu:", error);
        }
    }

    // Ch·∫°y l·∫ßn ƒë·∫ßu
    initChart();
    reloadData();

    // L·∫∑p l·∫°i m·ªói 5 gi√¢y
    setInterval(reloadData, 5000);

</script>

</body>
</html>